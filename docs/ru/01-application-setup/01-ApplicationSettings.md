# Настройки Приложения

Общие настройки приложения Checkita Data Quality конфигурируются в 
[Hocon](https://github.com/lightbend/config/blob/main/HOCON.md) файле `application.conf`, который
передается в приложение во время его старта. Все настройки задаются внутри секции `appConfig`.

Единственный параметр, который задается на верхнем уровне - это `applicationName`: имя Spark приложения.
Это параметр опциональный, и если он не задан, то приложение будет запущено с именем `Checkita Data Quality` 
по умолчанию.

Остальные настройки приложения задаются в соответствующих под-секциях, которые описаны ниже:

## Настройки даты и времени

Настройки даты и времени описываются в секции `dateTimeOptions`. Для более подробной информации о работе с датами в 
фреймворке Checkita Data Quality, см. главу [Работа с Датами](../02-general-concepts/01-WorkingWithDateTime.md).

Параметры для работы с датами следующие:

* `timeZone` - Временная зона, в которой указано строковое представление даты.
  *Опционально, по умолчанию `"UTC"`*.
* `referenceDateFormat` - формат даты/времени, которые используется для строкового представления референсной даты.
  *Опционально, по умолчанию `"yyyy-MM-dd'T'HH:mm:ss.SSS"`*.
* `executionDateFormat` - формат даты/времени, которые используется для строкового представления даты старта приложения.
  *Опционально, по умолчанию `"yyyy-MM-dd'T'HH:mm:ss.SSS"`*

Если секция `dateTimeOptions` не определена, то будут использоваться значения по умолчанию для всех 
вышеуказанных параметров.

## Активаторы

Секция `enablers` в файле с настройками приложения определяет различные бинарные активаторы или числовые параметры,
которые контролируют различные аспекты исполнения data quality пайплайна:

* `allowSqlQueries` - Бинарный параметр, который контролирует возможность использования произвольных SQL запросов при
  конфигурировании пайплайна. *Опционально, по умолчанию `false`*
* `allowNotifications` - Бинарный параметр, который контролирует возможность отправки уведомлений пользователям.
  *Опционально, по умолчанию `false`*
* `aggregatedKafkaOutput` - Бинарный параметр, который позволяет отправлять агрегированные сообщения для Kafka таргетов 
  (по одному сообщению на каждый тип таргета). По умолчанию отправляется отдельное сообщение в Kafka для каждой сущности.
  *Опционально, по умолчанию `false`*
* `enableCaseSensitivity` - Бинарный параметр, который устанавливает чувствительность к регистру в именах колонок.
  Таким образом контролируется, как имена колонок будут сравниваться между собой и как будет происходить их поиск в источнике.
  *Опционально, по умолчанию `false`*
* `errorDumpSize` - Максимальное количество ошибок, которые могут быть собраны для отдельной метрики. Фреймворк имеет
  возможность собирать данные из строки в источнике, для которой вычисление метрики завершилось с ошибкой. Однако,
  для того, чтобы предотвратить OOM, максимальное количество ошибок необходимо ограничить в разумных пределах. Так,
  максимально допустимое количество ошибок на метрику ограничено на уровне `10000`. Но его также можно дополнительно
  снизить задав этот параметр. *Опционально, по умолчанию `10000`*
* `outputRepartition` - Устанавливает количество партиций при записи результатов в файлов.
  По умолчанию записывается один файл. *Опционально, по умолчанию `1`*

Если секция `enablers` не определена, то будут использоваться значения по умолчанию для всех
вышеуказанных параметров.

## Конфигурация Хранилища

Параметры для подключения к базе данных с результатами работы Data Quality пайплайнов задаются в секции `storage` файла
с настройками приложения.

Для более подробной информации о хранилище результатов
см. главу [Хранилище Результатов](../01-application-setup/03-ResultsStorage.md).

Таким образом, для настройки подключения к базе данных с результатами, необходимо задать следующие параметры:

* `dbType` - Тип базы данных, которая используется для хранения результатов. *Обязательно*.
* `url` - URL для подключения к базе данных (без указания протоколов). *Обязательно*.
* `username` - Имя пользователя для подключения к базе данных (если требуется). *Опционально*.
* `password` - Пароль для подключения к базе данных (если требуется). *Опционально*.
* `schema` - Схема в которой находятся таблицы с результатами Data Quality (если требуется). *Опционально*.

> **ВАЖНО** Если секция `storage` не определена, то приложение будет запущено без подключения к базе данных с результатами:
>
> * резултаты не будут сохранены (будет возможна только отправка таргетов);
> * трендовые проверки (используются для определения аномалий в данных) не будут выполнены, т.к. им для работы
>   требуются исторические данные.

## Конфигурация Email

Для того чтобы отправлять уведомления на Email, необходимо настроить подключение к SMTP серверу,
которое конфигурируется в секции `email` файла с настройками приложения со следующими параметрами:

* `host` - Адрес SMTP сервера. *Обязательно*.
* `port` - Порт для подключения к SMTP серверу. *Обязательно*.
* `address` - Адрес отправителя. *Обязательно*.
* `name` - Имя отправителя. *Обязательно*.
* `sslOnConnect` - Бинарный параметр, указывающий на необходимость использования SSL для подключения.
  *Опционально, по умолчанию `false`*.
* `tlsEnabled` - Бинарный параметр, указывающий на необходимость поддержки TLS при подключении.
  *Опционально, по умолчанию `false`*.
* `username` - Имя пользователя для подключения к SMTP серверу (если требуется). *Опционально*.
* `password` - Пароль для подключения к SMTP серверу (если требуется). *Опционально*.

Если секция `email` не определена, то уведомления на Email не могут быть отправлены. При этом, если такие уведомления
были сконфигурированы в настройках пайплайна, то во время исполнения будет брошена соответсвующая ошибка.

## Конфигурация Mattermost

Для того чтобы отправлять уведомления в Mattermost, необходимо настроить подключение к Mattermost API,
которое конфигурируется в секции `mattermost` файла с настройками приложения со следующими параметрами:

* `host` - адрес по которому доступен Mattermost API.
* `token` - Токен для доступа к Mattermost API (использование ботов предпочтительно для отправки уведомлений).

Если секция `mattermost` не определена, то уведомления в Mattermost не могут быть отправлены.
При этом, если такие уведомления были сконфигурированы в настройках пайплайна,
то во время исполнения будет брошена соответсвующая ошибка.

## Общие Spark Параметры

В настройках приложения также возможно указать набор Spark-параметров, которые являются общими для большинства
запускаемых Data Quality пайплайнов. Такие параметры должны быть указаны в списке `defaultSparkOptions` как строки
в формате `spark.param.name=spark.param.value`.

## Пример Файла с Настройками Приложения

Hocon формат поддерживает подстановку переменных, а фреймворк Checkita Data Quality, в свою очередь, имеет механизм
для того, чтобы добавить дополнительные переменные в конфигурационные файлы по время исполнения. Для более подробной
информации, см. главу [Использование Переменных Окружения и Дополнительных Переменных](../02-general-concepts/02-EnvironmentAndExtraVariables.md).

```hocon
appConfig: {

  applicationName: "Custom Data Quality Application Name"
  
  dateTimeOptions: {
    timeZone: "GMT+3"
    referenceDateFormat: "yyyy-MM-dd"
    executionDateFormat: "yyyy-MM-dd-HH-mm-ss"
  }

  enablers: {
    allowSqlQueries: false
    allowNotifications: true
    aggregatedKafkaOutput: true
  }

  defaultSparkOptions: [
    "spark.sql.orc.enabled=true"
    "spark.sql.parquet.compression.codec=snappy"
    "spark.sql.autoBroadcastJoinThreshold=-1"
  ]

  storage: {
    dbType: "postgres"
    url: "localhost:5432/public"
    username: "postgres"
    password: "postgres"
    schema: "dqdb"
  }

  email: {
    host: "smtp.some-company.domain"
    port: "25"
    username: "emailUser"
    password: "emailPassword"
    address: "some.service@some-company.domain"
    name: "Data Quality Service"
    sslOnConnect: true
  }

  mattermost: {
    host: "https://some-team.mattermost.com"
    token: ${dqMattermostToken}
  }
}
```

