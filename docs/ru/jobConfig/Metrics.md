# Metrics

Подсчет метрик - это основная часть работы фреймворка **Checkita**. Они позволяют рассчитывать
показатели свойственные данным как таковым, а также вычислять различные бизнес-показатели, которые могут
сигнализировать о проблемах в данных.

Все метрики подразделяются на три большие группы:

* **File Metrics** - метрики, которые считаются на уровне всего источника.
  На текущий момент поддерживается только подсчет количества строк: `rowCount`.
* **Column Metrics** - колоночные метрики, которые рассчитываются
  исходя из значений в ячейках заданных колонок.
* **Composed Metrics** - композиционные метрики, которые рассчитываются
  на основе File Metrics и Column Metrics.

Пример раздела **metrics** в конфигурационном файле показан ниже:

```hocon
metrics: {
  file: {
    rowCount: [
      {id: "hive_table1_row_cnt", description: "Row count in hive_table1", source: "hive_table1"},
      {id: "csv_file1", description: "Row count in csv_file1", source: "csv_file1"}
    ]
  }
  column: {
    distinctValues: [
      {
        id: "fiexed_file1_dist_name", description: "Distinct names in fiexed_file1",
        source: "fiexed_file1", columns: ["name"]
      }
    ]
    nullValues: [
      {id: "hive_table1_nulls", description: "Null values in columns id and name", source: "hive_table1", columns: ["id", "name"]}
    ]
    completeness: [
      {id: "orc_data_compl", description: "Completness of column id", source: "orc_data", columns: ["id"]}
    ]
    avgNumber: [
      {id: "avro_file1_avg_bal", description: "Avg number of column balance", source: "avro_file1", columns: ["balance"]}
    ]
    regexMatch: [
      {
        id: "parquet_file_inn_regex", description: "Regex match for inn column", source: "parquet_file",
        columns: ["inn"], params: {regex: """^\d{10}$"""}
      }
    ]
    stringInDomain: [
      {
        id: "orc_data_segment_domain", description: "Segment should be in domain", source: "orc_data",
        columns: ["segment"], params: {domain: ["FI", "MID", "SME", "INTL", "CIB"]}
      }
    ]
    topN: [
      {
        id: "table1_top3_currency", description: "Top 3 currency in table1", source: "table1",
        columns: ["currency"], params: {targetNumber: 3, maxCapacity: 10}
      }
    ]
  }
  composed: [
    {
      id: "pct_of_null", description: "Percent of null values in hive_table1",
      formula: "100 * $hive_table1_nulls / $hive_table1_row_cnt"
    }
  ]
}
```

## File Metrics
### rowCount

Данная метрика посчитывает количество строк в источнике. Необходимые параметры:

* `id` - идентификатор метрики
* `description [optional]` - описание метрики. Указывать необязательно.
* `source` - идентификатор источника, по которому будет рассчитываться метрика.

## Column Metrics

Все колоночные метрики имеют унифицированный формат описания, как показано ниже.
Некоторые из них требуют указания дополнительных параметров для расчета, которые указываются
в подразделе `params`:

```hocon
{
  id: "идентификтор метрики"
  description: "описание метрики [опционально]"
  source: "идентификатор источника"
  columns: ["список", "колонок"]
  params: { // дополнительные параметры (если необходимо)
    param1: "value1",
    param2: "value2"
  }
}
```

Колоночные метрики могут быть рассчитаны по нескольким колонкам сразу.
Это значит, что результат метрики будет посчитан по всем ячейкам в этих колонках.
Например, если в метрике nullValues задать список из трех колонок, то результатом будет
общее количество null значений в этих колонках. Аналогично и с другими метриками.
Есть особые виды метрик, которые могут быть посчитаны только по одной или только по двум колонкам.
Об этом будет указано явно в описании метрики.

**Статусы метрик**

Для большинства колоночных метрик можно явно определить, является ли вычисление метрики для конкретной строки в данных
успешным или нет. Например, для метрики `regexMatch`, успешным будет ситуация, когда в строке значения в указанных
колонках совпадают с regex-шаблоном. И, соответственно, если совпадения нет - то это ошибка.

Метрики, которые поддерживают такое поведение, называются `Statusable Metric`.
И для таких метрик реализован механизм сбора ошибок, который подробно описан в разделе [Targets](./Targets.md).

Далее, при описании каждой метрики будет указано, является ли она `Statusable` или нет, и описан сценарий, когда метрика
считается успешно посчитанной, а когда с ошибкой.

### distinctValues

Подсчитывает количество уникальных значений в ячейках.
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### approximateDistinctValues

Рассчитывает приблизительное количество уникальных значений в колонке с помощью алгоритма HyperLogLog.
***Работает только с одной колонкой.***
Дополнительные параметры: `accuracyError` (опционально, по умолчанию 0.01):

Метрика **не является** `Satusable`.

```hocon
params: {accuracyError: 0.05}
```

### nullValues

Подсчитывает количество null в ячейках.
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке **не** `Null`;
* Ошибка, если значение в колонке `Null`.

### duplicateValues

Подсчитывает количество дублей в строках.
Дополнительные параметры (`params`) отсутствуют.

> Важно: В случае, если на вход метрике подан список из нескольких колонок,
> то дублем считается полное совпадение кортежа значений в этих колонках. Например:
>
>  * `['PI', 3.14, 'short'] и ['PI', 3.14, 'short']` - это дубли
>  * `['PI', 3.14, 'short'] и ['PI', 'short', 3.14]` - это **НЕ** дубли
>  * `['PI', 3.14, null] и ['PI', null, 3.14]` - это **НЕ** дубли

Метрика **является** `Satusable`:

* Успешно, если значение в колонке(ах) уникально;
* Ошибка, если найден дубль.

> Важно: Ввиду особенностей распределенных вычислений, датасеты делятся на части и обрабатываются параллельно.
> При этом, дубли могут оказаться в разных потоках. В этом случае они будут идентифицированы только на этапе `reduce`,
> и для таких случаев не будет возможности собрать данные из строки, которая является дубликатом,
> т.к. она уже была прочитана ранее на этапе `map`.
> ***Резюмируя: метрика найдет все дубликаты, но не по всем из них могут быть собраны строки с ошибками.***

### emptyValues

Подсчитывает количество пустых ячеек (с пустой строкой).
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке **не является** пустой строкой;
* Ошибка, если значение в колонке - это пустая строка.

### completeness

Рассчитывает меру полноты в колонке/колонках: `(cell_count - null_count) / cell_count`
Дополнительные параметры: `includeEmptyStrings` (опционально, по умолчанию false),
чтобы дополнительно учитывать пустые ячейки.

Метрика **не является** `Satusable`.

```hocon
params: {includeEmptyStrings: true}
```

### sequenceCompleteness

Рассчитывает меру полноты инкрементальной последовательности целых чисел.
Иначе говоря, ищет пропущенные элементы в последовательности и возвращает отношение:
`фактическое количество элементов / требуемое количичество элементов`.
При этом последовательность не обязана быть отсортированной.

***Работает только с одной колонкой.***

Фактическое количество элементов - это количество уникальных элементов в последовательности.
Данная метрика определяет его точно, и поэтому ей требуется `O(N)` памяти для хранения значений.
Для очень больших последовательностей (десятки миллионов и более записей) рекомендуется использовать
метрику ***approximateSequenceCompleteness***, которая определяет количество уникальных элементов приближенно.

Требуемое количество элементов определяется по формуле: `(max_value - min_value) / increment + 1`,
где:
* `min_value` - минимальное значение в последовательности;
* `max_value` - максимальное значение в последовательности;
* `increment` - шаг последовательности, по умолчанию - 1.

Таким образом, в дополнительных параметрах для метрики можно указать:
* `incremet [optional]` - шаг последовательности. По умолчанию 1;

Метрика **не является** `Satusable`.

```hocon
params: {increment: 4}
```

### approximateSequenceCompleteness

Рассчитывает меру полноты инкрементальной последовательности целых чисел
***приближенно*** с помощью алгоритма HyperLogLog.
Иначе говоря, ищет пропущенные элементы в последовательности и возвращает отношение:
`фактическое количество элементов / требуемое количичество элементов`.
При этом последовательность не обязана быть отсортированной.

***Работает только с одной колонкой.***

Фактическое количество элементов - это количество уникальных элементов в последовательности.
Данная метрика определяет его приближенно, используя вероятностный алгоритм HyperLogLog, и поэтому требует значительно
меньше памяти.

Требуемое количество элементов определяется по формуле: `(max_value - min_value) / increment + 1`,
где:
* `min_value` - минимальное значение в последовательности;
* `max_value` - максимальное значение в последовательности;
* `increment` - шаг последовательности, по умолчанию - 1.

Таким образом, в дополнительных параметрах для метрики можно указать:
* `incremet [optional]` - шаг последовательности. По умолчанию 1;
* `accuracyError [optional]` - точность вычисления уникальных значений в последовательности. По умолчанию 0.01.

Метрика **не является** `Satusable`.

```hocon
params: {increment: 4, accuracyError: 0.05}
```


### minString

Рассчитывает минимальную длину строки в ячейках.
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### maxString

Рассчитывает максимальную длину строки в ячейках.
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### avgString

Рассчитывает среднюю длину строки в ячейках.
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### stringLength

Рассчитывает количество ячеек, которые удовлетворяют условию по длине строки.
Дополнительные параметры:

* `length` - длина строки для сравнения.
* `compareRule` - правило сравнения. Принимает одно из следующих значений:
    * `eq` (==), `lt` (<), `lte` (<=), `gt` (>), `gte` (>=).

Метрика **является** `Satusable`:

* Успешно, если значение в колонке удовлетворяют условию по длине строки;
* Ошибка в обратном случае.

```hocon
params: {length: 25, compareRule: "eq"}
```

### stringInDomain

Подсчитывает количество ячеек в колонке/колонках, значения которых
попадают в указанное множество значений.

Дополнительные параметры: `domain` - список возможных значений.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке попадает в указанное множество значений;
* Ошибка в обратном случае.

```hocon
params: {domain: ["FI", "MID", "SME", "INTL", "CIB"]}
```

### stringOutDomain

Подсчитывает количество ячеек в колонке/колонках, значения которых **не**
попадают в указанное множество значений.

Дополнительные параметры: `domain` - список возможных значений.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке **не** попадает в указанное множество значений;
* Ошибка в обратном случае.

```hocon
params: {domain: ["FI", "MID", "SME", "INTL", "CIB"]}
```

### stringValues

Подсчитывает количество ячеек, значение в которых совпадает с заданным.
Дополнительные параметры: `compareValue` - целевое значение.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке совпадает с заданным;
* Ошибка в обратном случае.

```hocon
params: {compareValue: "MICR"}
```

### regexMatch

Подсчитывает количество ячеек, значения в которых совпадают с регулярным выражением.
Дополнительные параметры: `regex` - регулярное выражения для сравнения.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке совпадает с заданным регулярным выражением;
* Ошибка в обратном случае.

```hocon
params: {regex: """^\d{10}$"""}
```

> **Tip**: Регулярные выражения нужно задавать в тройных кавычках.
> Либо в одинарных, но с экранированием специальных символов с помощью ` \ `

### regexMismatch

Подсчитывает количество ячеек, значения в которых **не** совпадают с регулярным выражением.
Дополнительные параметры: `regex` - регулярное выражения для сравнения.

Метрика **является** `Satusable`:

* Успешно, если значение в колонке **не** совпадает с заданным регулярным выражением;
* Ошибка в обратном случае.

```hocon
params: {regex: """^\d{10}$"""}
```

### formattedDate

Подсчитывает количество ячеек, где строковое значение имеет указанный формат даты.
Дополнительные параметры: `dateFormat [optional]` - целевой формат даты. Формат даты указывается  
как [Joda DateTime Format](https://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html).
Формат даты по умолчанию: `yyyy-MM-dd'T'HH:mm:ss.SSSZ`. Если указанные колонки имеют тип `Timestamp`,
то подразумевается, что они подходят под любой формат даты и метрика вернет общее количество не пустых ячеек.
Соответственно, и формат даты указывать не нужно.

Метрика **является** `Satusable`:

* Успешно, если строковое значение в колонке имеет указанный формат даты;
* Ошибка в обратном случае.

```hocon
params: {dateFormat: "yyyy-MM-dd"}
```

### formattedNumber

Подсчитывает количество ячеек, где числовое значение подходит под указанный формат.
Дополнительные параметры:

* `precision` - общее количество знаков числа (за исключением десятичного разделителя).
* `scale` - количество знаков в дробной части.
* `compareRule [optional]` - правило сравнения:
    * `inbound` - число должно "вписываться" в указанный формат (precision и scale числа меньше или равны заданным)
    * `outbound` - число быть за рамками указанного формата (precision и scale числа строго больше заданных).
    * Привило сравнения по умолчанию - `inbound`.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке подходит под указанный формат;
* Ошибка в обратном случае.

```hocon
params: {precision: 14, scale: 8, compareRule: "outbound"}
```

### minNumber

Находит минимальное число в ячейках. Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### maxNumber

Находит максимальное число в ячейках. Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### sumNumber

Находит сумму чисел в ячейках. Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### avgNumber

Вычисляет среднее значение чисел в колонке. ***Работает только с одной колонкой.***
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### stdNumber

Вычисляет стандартное отклонение для чисел в колонке. ***Работает только с одной колонкой.***
Дополнительные параметры (`params`) отсутствуют.

Метрика **не является** `Satusable`.

### castedNumber

Подсчитывает количество ячеек, где строковое значение может быть переведено в численное (double).
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если строковое значение в колонке может быть переведено в численное;
* Ошибка в обратном случае.

### numberInDomain

Подсчитывает количество ячеек, числовые значения которых попадают в указанное множество значений.

Дополнительные параметры: `domain` - список возможных числовых значений.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке попадает в указанное множество;
* Ошибка в обратном случае.

```hocon
params: {domain: [1.23, 2.34, 3.45, 4.56, 5.67]}
```

### numberOutDomain

Подсчитывает количество ячеек, числовые значения которых **не** попадают в указанное множество значений.

Дополнительные параметры: `domain` - список возможных числовых значений.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке **не** попадает в указанное множество;
* Ошибка в обратном случае.

```hocon
params: {domain: [1.23, 2.34, 3.45, 4.56, 5.67]}
```

### numberLessThan

Подсчитывает количество ячеек, где числовое значение меньше заданного.
Дополнительные параметры:

* `compareValue` - число для сравнения.
* `includeBound [optional]` - указывает, нужно ли включать `compareValue` в интервал для сравнения.
  По умолчанию - false.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке меньше заданного;
* Ошибка в обратном случае.

```hocon
params: {compareValue: 3.14, includeBound: true}
```

### numberGreaterThan

Подсчитывает количество ячеек, где числовое значение больше заданного.
Дополнительные параметры:

* `compareValue` - число для сравнения.
* `includeBound [optional]` - указывает, нужно ли включать `compareValue` в интервал для сравнения.
  По умолчанию - false.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке больше заданного;
* Ошибка в обратном случае.

```hocon
params: {compareValue: 3.14, includeBound: true}
```

### numberBetween

Подсчитывает количество ячеек, где числовое значение находится внутри заданного интервала.
Дополнительные параметры:

* `lowerCompareValue` - нижняя граница интервала.
* `upperCompareValue` - верхняя граница интервала.
* `includeBound [optional]` - указывает, нужно ли включать границы в интервал для сравнения.
  По умолчанию - false.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке находится внутри заданного интервала;
* Ошибка в обратном случае.

```hocon
params: {lowerCompareValue: 17, upperCompareValue: 71, includeBound: true}
```

### numberNotBetween

Подсчитывает количество ячеек, где числовое значение находится вне заданного интервала.
Дополнительные параметры:

* `lowerCompareValue` - нижняя граница интервала.
* `upperCompareValue` - верхняя граница интервала.
* `includeBound [optional]` - указывает, нужно ли включать границы в интервал для сравнения.
  По умолчанию - false.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке находится вне заданного интервала;
* Ошибка в обратном случае.

```hocon
params: {lowerCompareValue: 10, upperCompareValue: 22, includeBound: true}
```

### numberValues

Подсчитывает количество ячеек, числовое значение в которых совпадает с заданным.
Дополнительные параметры: `compareValue` - целевое числовое значение.

Метрика **является** `Satusable`:

* Успешно, если числовое значение в колонке совпадает с заданным;
* Ошибка в обратном случае.

```hocon
params: {compareValue: 42}
```

### TDigest Metrics

Метрики, которые вычисляются персентили и квантили с помощью библиотеки [TDigest](https://github.com/isarn/isarn-sketches).

**Данные метрики работают только с одной колонкой и не являются `Satusable`.**

Общим дополнительным параметром для метрик этой группы является `accuracyError`,
который задает точность вычисления метрик. Этот параметр опциональный и по умолчанию равен 0.005.

#### medianValue

Вычисляет медианное значение для чисел в колонке (второй квантиль).

#### firstQuantile

Вычисляет первый квантиль для чисел в колонке.

#### thirdQuantile

Вычисляет третий квантиль для чисел в колонке.

#### getQuantile

Вычисляет произвольный квантиль для чисел в колонке.
Дополнительный параметр: `targetSideNumber` - число в интервале [0, 1], соответсвующее квантилю, который будет вычислен.

```hocon
params: {accuracyError: 0.01, targetSideNumber: 0.15}
```

#### getPercentile

Метрика, обратная метрике [getQuantile](#getQuantile): вычисляет значение процентиля (квантиль в %),
которое соответствует указанному числу из множества значений в колонке.
Дополнительный параметр: `targetSideNumber` - число из множества значений в колонке, для которого будет вычислен
соответсвующий персентиль.

```hocon
params: {accuracyError: 0.01, targetSideNumber: 30}
```

### Multi-Column Metrics

Метрики в этой группе сравнивают значения ячеек в колонках между собой построчно
и подсчитывают число строк, где результат сравнения удовлетворяет критерию.

#### columnEq

Подсчитывает число строк, где значения в ячейках указанных колонок совпадают.
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значения в указанных колонках совпадают;
* Ошибка в обратном случае.

#### dayDistance

Подсчитывает количество строк, где разница значений даты между двумя колонками
меньше заданного порога (строго меньше). **Работает только с двумя колонками.**
Дополнительные параметры:

* `threshold` - максимальная разница между двумя датами в днях.
* `dateFormat [optional]` - формат даты. Формат даты указывается как
  [Joda DateTime Format](https://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html).
  Формат даты по умолчанию: `yyyy-MM-dd'T'HH:mm:ss.SSSZ`. Если указанные колонки имеют тип `Timestamp`,
  то подразумевается, что они подходят под любой формат даты. Соответственно, формат даты указывать не нужно.

Метрика **является** `Satusable`:

* Успешно, если разница значений даты между двумя колонками меньше заданного порога;
* Ошибка в обратном случае.

```hocon
params: {threshold: 1, dateFormat: "yyyy-MM-dd'T'HH:mm:ss.SSSZ"}
```

#### levenshteinDistance

Подсчитывает количество строк, где расстояние Левенштейна между строковыми значениями в ячейках
этих колонок меньше или равно заданному порогу. **Работает только с двумя колонками.**
Дополнительные параметры:

* `threshold` - пороговое значение расстояния Левенштейна.
* `normalize [optional]` - флаг true/false указывающий, будет ли расстояние Левенштейна нормироваться по отношению
  к максимальной из двух длине строки. По умолчанию - false. **Если результат нормируется, то пороговое значение
  `threshold` должно быть в диапазоне [0, 1].**

Метрика **является** `Satusable`:

* Успешно, если расстояние Левенштейна между строковыми значениями в колонках меньше или равно заданному порогу;
* Ошибка в обратном случае.

```hocon
params: {threshold: 3}
```

#### coMoment

Вычисляет ковариационный момент значений в двух колонках (co-moment). **Работает только с двумя колонками.
Для корректного расчета метрики, в колонках не должно быть пустых ячеек, и значения всех ячеек должны быть числовыми.**
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значения в колонках не пустые и являются числовыми;
* Ошибка в обратном случае.

#### covariance

Вычисляет ковариацию значений в двух колонках. **Работает только с двумя колонками.
Для корректного расчета метрики, в колонках не должно быть пустых ячеек, и значения всех ячеек должны быть числовыми.**
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значения в колонках не пустые и являются числовыми;
* Ошибка в обратном случае.

#### covarianceBessel

Вычисляет ковариацию значений в двух колонках с поправкой Бесселя. **Работает только с двумя колонками.
Для корректного расчета метрики, в колонках не должно быть пустых ячеек, и значения всех ячеек должны быть числовыми.**
Дополнительные параметры (`params`) отсутствуют.

Метрика **является** `Satusable`:

* Успешно, если значения в колонках не пустые и являются числовыми;
* Ошибка в обратном случае.

### Special Metrics

#### topN

TopN метрика рассчитывает приблизительные N наиболее часто встречающихся значений в колонке.
Метрика вычисляется с помощью библиотеки [Twitter Algebird](https://github.com/twitter/algebird),
в которой реализованы методы абстрактной алгебры для Scala.
**Работает только с одной колонкой!** Дополнительные параметры:

* `targetNumber [optional]` - задает число N значений для поиска. По умолчанию - 10.
* `maxCapacity [optional]` - максимальный размер контейнера для хранения Top-значений. По умолчанию - 100.

Метрика **не является** `Satusable`.

```hocon
params: {targetNumber: 4, maxCapacity: 10}
```

> TopN метрика возвращает множественный результат: по одной строке на каждое значение из top N.
> Формат резлультата будет следующий:
>
> * идентификатор сопровождается суффиксом с указанием позиции в топе: id + '_' + position
> * В качестве числового результата выводится частота встречаемости значения.
> * В качестве дополнительного результата выводится само значение из топа.

## Composed Metrics

Композиционные метрики задаются с помощью формулы (указывается в поле `formula`) для их вычисления,
в которой базовые метрики указываются с `$` префиксом. Поддерживаются базовые математические операции (+-*/),
возведение в степень (^), а также группировка с помощью круглых скобок.

```hocon
{
  id: "alternative_completeness",
  description: "Percent of non-null values in hive_table1",
  formula: "100 * ($hive_table1_row_cnt - $hive_table1_nulls) / $hive_table1_row_cnt"
}
```